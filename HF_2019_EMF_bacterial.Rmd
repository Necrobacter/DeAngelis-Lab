---
title: "EMF and Bacterial diversity"
output:
  html_document:
    df_print: paged
---

We are interested in looking at the relationship between ecosystem multifunctionality and the bacterial diversity.

```{r}
# load packages
library(tidyverse)
library(multifunc)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(lme4)
library(AICcmodavg)
```

```{r}
# read in the data
prop <- read.csv("/Users/melissashinfuku/Documents/UMass/Year 4/Ecosystem_multifunctionality/Sequencing/16S/bact_proportional_diversity.csv")
prop$X <- NULL
rownames(prop) <- prop$Row.names

rare <- read.csv("/Users/melissashinfuku/Documents/UMass/Year 4/Ecosystem_multifunctionality/Sequencing/16S/bact_diversity_without_rep.csv")
rare$X <-NULL
rownames(rare) <- rare$Row.names

emf <- read.csv("/Users/melissashinfuku/Documents/UMass/Ecosystem-multifunctionality/HF_log_transformed_functions.csv")
emf$X <- NULL
rownames(emf) <- emf$Sample
```

```{r}
# check order of row names before merging
rownames(prop) == rownames(rare)

# merge the two diversity datasets
div <- cbind(rare, prop$Shannon, prop$Simpson)
colnames(div)[9] <- "prop.Shannon"
colnames(div)[10] <- "prop.Simpson"

emf.div <- right_join(emf, div)
```

# Plotting

```{r}
# rarefied diversity
(
  p <- ggplot(emf.div, aes(x = Shannon, y = meanFunction)) + geom_point(aes(color = Warming)) + scale_color_manual(values = c("grey", "red3")) + geom_smooth(alpha = 0.2, aes(color = Warming), method = "lm", formula = y~x) + labs(color = "Warming", linetype = "Warming") + theme_bw() + ylab("Multifunctionality Index \n") + xlab("\n Bacterial Diversity (Shannon's H)")
)

# 2x2 facet
(
  p2x2 <- p + facet_grid(cols = vars(Horizon), rows = vars(Timepoint)) + theme(axis.title = element_text(size = 15), axis.text = element_text(size = 12), strip.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 15))
)

# 4x1 facet

(
  p4x1 <- p + facet_grid(cols = vars(Horizon, Timepoint))
)
# proportional diversity

  #p3 <- ggplot(emf.div, aes(x = prop.Shannon, y = meanFunction)) + geom_point(aes(color = Warming)) + scale_color_manual(values = c("grey", "red3")) + geom_smooth(aes(color = Warming), method = "lm", formula = y~x) + theme_bw()



  #p4 <- p3 + facet_grid(cols = vars(Horizon, Timepoint)) + stat_cor(aes(color = Warming), label.x = rep(5.25, times = 4)) + theme(axis.text = element_text(size = 10), axis.title = element_text(size = 15), legend.text = element_text(size = 10), legend.title = element_text(size = 15), title = element_text(size = 15), strip.text = element_text(size = 10)) + ylab("Multifunctionality index \n") + xlab("\n bacterial Shannon diversity") + guides(color = guide_legend(title = "Warming"))



  #p5 <- p4 + facet_grid(cols = vars(Horizon, Site))


```

Let's see if any of these relationships are significant

```{r}
# Shannon diversity
# simplest model
fit <- glm(meanFunction ~ Shannon, data = emf.div)

summary(fit)
plot(residuals(fit))

# additive
fit.add <- glm(meanFunction ~ Shannon + Warming + Timepoint + Horizon, data = emf.div)

summary(fit.add)
plot(residuals(fit.add))

# interaction between warming and shannon
fit.shannon <- glm(meanFunction ~ Shannon * Warming + Timepoint + Horizon, data = emf.div)

summary(fit.shannon)
plot(residuals(fit.shannon))

# interaction between warming, shannon, and timepoint
fit.shannon.time <- glm(meanFunction ~ Shannon * Timepoint * Warming + Horizon, data = emf.div)

summary(fit.shannon.time)
plot(residuals(fit.shannon.time))

# interaction between warming, shannon, horizon
fit.shannon.horizon <- glm(meanFunction ~ Shannon * Horizon * Warming + Timepoint, data = emf.div)

summary(fit.shannon.horizon)
plot(residuals(fit.shannon.horizon))

# interaction between warming, shannon, horizon, and timepoint
fit.shannon.time.horizon <- glm(meanFunction ~ Shannon * Warming * Timepoint * Horizon, data = emf.div)

summary(fit.shannon.time.horizon)
plot(residuals(fit.shannon.time.horizon))
```

All the residual plots look good (IE random distribution of points).

Let's compare all these models using delta AIC.

```{r}
mod.list <- list("simple" = fit, "add" = fit.add, "shan.warm" = fit.shannon, "shan.warm.time" = fit.shannon.time, "shan.warm.hor" = fit.shannon.horizon, "full" = fit.shannon.time.horizon)
aictab(mod.list)
```

The additive model with Shannon, warming, timepoint, and horizon is the best fitting model based on Delta AIC. It should also be noted that the model with an interaction between Shannon diversity and warming is similar (IE less than 2 delta AIC units) to the simplest model. But we will proceed with the simplest model.

```{r}
summary(fit.add)
```

The warmed plots have a weaker relationship between Shannon diversity and EMF compared to the control plots. Additionally, the fall timepoints have a stronger relationship between EMF and Shannon diversity compared to the summer timepoints.

If we want to look at individual comparisons between heated and control for different horizons and timepoints we need to subset the data

```{r}
fit.org.july <- glm(meanFunction ~ Shannon + Warming, data = emf.div, subset = emf.div$Horizon == "Organic" & emf.div$Timepoint == "July")
summary(fit.org.july)

fit.org.oct <- glm(meanFunction ~ Shannon + Warming, data = emf.div, subset = emf.div$Horizon == "Organic" & emf.div$Timepoint == "October")
summary(fit.org.oct)

fit.min.july <- glm(meanFunction ~ Shannon + Warming, data = emf.div, subset = emf.div$Horizon == "Mineral" & emf.div$Timepoint == "July")
summary(fit.min.july)

fit.min.oct <- glm(meanFunction ~ Shannon + Warming, data = emf.div, subset = emf.div$Horizon == "Mineral" & emf.div$Timepoint == "October")
summary(fit.min.oct)
```

